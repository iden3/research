% !TEX root =/home/marta/Dropbox/Documents/Especificacions/Pedersen/Description.tex

Let $M$ be a sequence of bits. We construct the Pedersen hash of $M$ as follows:
% We construct the Pedersen hash as follows: 
\begin{itemize}
	\item Sample $P_0,P_1,\dots,P_k$ uniformly in $\G$ (for some specified integer $k$). %Cal que k geq l.
	%, in our case $k=5$).
	%	Let $P_0,P_1,\dots,P_k$ be uniformly sampled generators of $\G$. 
	% These points only need to be computed once.
	% First, we sample elements (generators) $P_0,P_1,\dots,P_k$ uniformly in $\G$ (for some specified integer $k$, in our case $k=5$). 
	% En el codi de Jordi: all√≤ de typeof?
	\item   Split $M$ into sequences of 4 bits{\footnote{If $M$ is not a multiple of 4, pad $M$ to a multiple of 4 bits by appending zero bits.}}. 
	More precisely, write  
	\begin{gather*}
		M = M_1M_2\dots M_l 
		\quad\text{where}\quad
		M_i = m_1m_2\dots m_{k_i}
		\quad\text{with}\quad 
		\begin{cases}
			k_i = 50 	\;\text{ for }  i = 0, \dots, l-1, \\
			k_l \leq 50,
		\end{cases}
	\end{gather*}
	where the $m_j$ terms are 4-bit chunks $[b_0^j\: b_1^j\: b_2^j\: b_3^j]$. 
	Define  
	$$ enc(m_j) = (2b_3^j-1) 
		\cdot (1+b_{0}^j+2b_{1}^j+4b^j_{2}) $$
	and let 
	$$ \langle M_i \rangle = \sum_{j=1}^{k_i} enc(m_j) \cdot 2^{5(j-1)}.	$$
	We define the Pedersen hash of $M$ as
	\begin{equation}
	\label{eq-ped}
		H(M) = \langle M_0 \rangle \cdot P_0 
		+  \langle M_1 \rangle \cdot P_1 
		+  \langle M_2 \rangle \cdot P_2 
		+ \dots + \langle M_l \rangle \cdot P_l.	
	\end{equation}
	Note that the expression above is a linear combination of elements of $\G$, 
	so itself is also an element of $\G$. 
	That is, the resulting Pedersen hash $H(M)$ is a point of the elliptic curve $E$ of order $r$.
\end{itemize}

The computation of the Pedersen hash has two steps: first, the base points $P_0, P_1, \dots, P_k$ need to be generated. This only needs to be done once, as they can be reused to compute hashes of other data. And secondly, the calculation of expression (\ref{eq-ped}). The circuits used to compute this sum are quite similar to the ones used to calculate the multiple of a point of an elliptic curve except that here we only work with the twisted Edwards form of $E$ and we can have many points precalculated, so instead of doubling all the time, we work with look-up tables. 